<!DOCTYPE html>
<html>

<head>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>
  <script>
    //marker found
    AFRAME.registerComponent('markerhandler', {
      schema: {
        soundSrc: {
          type: 'string'
        }
      },
      init: function() { 
        let curSound = document.querySelector(this.data.soundSrc);
        this.el.addEventListener('markerFound', () => {
          // Play the current sound file
          curSound.components.sound.playSound();
        });

        this.el.addEventListener('markerLost', () => {
          curSound.components.sound.stopSound();
        });
      }
    });

    var lastChangeTime = 0; // Variable to store the time of the last image change

    function changePicture(planeId) {
      var currentTime = Date.now(); // Get the current time
      var timeSinceLastChange = currentTime - lastChangeTime; // Calculate the time since the last change

      // If less than 500 milliseconds have passed since the last change, exit the function
      if (timeSinceLastChange < 500) {
        return;
      }

      var plane = document.getElementById(planeId);

      // Check if the new source is different from the current one
      var newSrc = plane.getAttribute('src') === 'assets/sample-ar-1.png' ? 'assets/asset1.jpg' : 'assets/sample-ar-1.png';

      // Update the image source and the time of the last change
      plane.setAttribute('src', newSrc);
      lastChangeTime = currentTime;
    };

    sceneEl.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
    });

    sceneEl.addEventListener("markerLost", (e) => {
      isMarkerVisible = false;
    });

    function handleRotation(event) {
      if (isMarkerVisible) {
        el.object3D.rotation.y +=
          event.detail.positionChange.x * rotationFactor;

        el.object3D.rotation.x +=
          event.detail.positionChange.y * rotationFactor;
      };
    };

    function handleScale(event) {
      if (isMarkerVisible) {
        this.scaleFactor *=
          1 + event.detail.spreadChange / event.detail.startSpread;

        this.scaleFactor = Math.min(
          Math.max(this.scaleFactor, this.data.minScale),
          this.data.maxScale
        );

        el.object3D.scale.x = scaleFactor * initialScale.x;
        el.object3D.scale.y = scaleFactor * initialScale.y;
        el.object3D.scale.z = scaleFactor * initialScale.z;
      }
    }
  </script>
  <style>
    body {
      margin: 0px;
      overflow: hidden;
    }

    a-scene {
      margin: 0px;
    }
  </style>
</head>

<body>
  <a-scene embedded vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true;" arjs='trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3_HAMMING63;' id="scene" gesture-detector>

    <!--sound files-->
    <a-sound id="sound1" src="assets/Intro to PLVIL.wav"></a-sound>
    <a-sound id="sound2" src="assets/Intro to AR.wav"></a-sound>
    <a-sound id="sound3" src="assets/Intro to Highlights.wav"></a-sound>

    <!--markers: planes-->
    <a-marker markerhandler="soundSrc: #sound1" type="barcode" value="0" raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;" onclick="changePicture('imagePlane1')" smooth-count="4" smooth-tolerance="0.05" smooth-threshold="1">
      <a-plane id="imagePlane1" position="0 0 0" rotation="-90 0 0" width="5.4" height="5.4" material="shader: flat; scale: 2 2 2 " src="assets/sample-ar-1.png" class="clickable" gesture-handler></a-plane>
    </a-marker>

    <a-marker markerhandler="soundSrc: #sound2" type="barcode" value="1" raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;" onclick="changePicture('imagePlane2')">
      <a-plane id="imagePlane2" position="0 0 0" rotation="-90 0 0" width="5.4" height="5.4" material="shader: flat; scale: 2 2 2" src="assets/sample-ar-2.png" class="clickable" gesture-handler></a-plane>
    </a-marker>

    <!--marker: 3d box-->
    <a-marker type="barcode" value="2">
      <a-box color="#1442CC" position="0 0 0" scale="3 3 3" rotation="-90 0 0" animation="property: rotation; to: 0 90 0; loop: true; dur: 2000" material="opacity: 0.8;" onclick="changeColor"></a-box>
    </a-marker>

    <!--marker: 3d model-->
    <a-assets>
      <a-asset-item id="animated-asset" src="https://raw.githubusercontent.com/nicolocarpignoli/nicolocarpignoli.github.io/master/ar-playground/models/CesiumMan.gltf"></a-asset-item>
    </a-assets>

    <a-marker id="animated-marker" type="barcode" value="3">
      <a-entity gltf-model="#animated-asset" scale="3 3 3" rotation="0 0 0"></a-entity>
      <a-sound src="assets/level-up.mp3" autoplay="false"></a-sound>
    </a-marker>

    <a-entity camera></a-entity>

  </a-scene>
</body>

</html>
